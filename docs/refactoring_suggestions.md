# コード改善提案書 (Refactoring Suggestions)

本ドキュメントでは、システムの保守性・拡張性・可読性を劇的に向上させるための、抜本的なリファクタリング方針を提案します。

## 1. クラス設計の最適化 (Class Design)

### 1.1 パーサーの Template Method パターン化
- **現状**: `MitsuiMansionParser` や `SumifuMansionParser` 等の各サブクラスが `_parsePropertyDetailPage` を丸ごとオーバーライドしており、テーブル構造の走査や例外処理が重複しています。
- **提案**:
    - `ParserBase` もしくは会社ごとの基底クラスに、汎用的な「テーブル走査エンジン」を実装する。
    - 各サブクラスは、抽出対象のラベル（例: `価格`, `所在地`）と、それに対応するデータ変換用のコールバック関数をマッピングした辞書（`MAPPING_DEFINITION`）を定義するだけに留める。
- **メリット**: 新しい物件種別の追加が定義の追記のみで完了し、ロジックの不整合が解消されます。

### 1.2 抽出ロジックのコンポーネント化 (Modular Utilities)
- **現状**: 価格の「1億2,000万円 -> 120000000」といった数値変換や、複雑な交通情報の正規表現抽出が各メソッド内にハードコードされています。
- **提案**:
    - `package.utils.converter` 等の独立したモジュールへ、これらの変換関数を抽出する。
    - **PropertyDataLinker** のような、サイトごとの表記の揺れ（例: `㎡` と `平米`）を吸収する中間層を設ける。
- **メリット**: 正規化ロジック単体でユニットテストが可能になり、品質が担保されます。

## 2. システム全体最適 (System-wide Optimization)

### 2.1 型安全性とスキーマの導入 (Schema-first approach)
- **現状**: 解析データが Django Model インスタンスとして直接受け渡されており、どのフィールドが解析済みで、どのフィールドが未解析（None）かの区別が実行時にしかわかりません。
- **提案**:
    - `Pydantic` や `dataclasses` を用いた「中間データスキーマ」を導入する。
    - パース直後にこのスキーマでバリデーションを行い、不正なデータ（例: 価格が負の値）は DB 保存前に遮断する。
- **メリット**: 型ヒントによる IDE の支援を最大限に受けられ、予期せぬ `AttributeError` を防止できます。

### 2.2 セレクタおよびパスの外部化・定数管理
- **現状**: `response.select_one("h1.headline1")` 等の CSS セレクタが実装コード内に埋め込まれています。
- **提案**:
    - 各パーサークラスのクラス定数、あるいは YAML/JSON 設定ファイルへセレクタ定義を分離する。
- **メリット**: サイトのレイアウト変更時に、ロジックに触れることなく設定値の変更のみで対応が可能になります。

### 2.3 API チェーンのミドルウェア化
- **現状**: API の連鎖（Start -> Region -> Area -> List -> Detail）がハードコードされており、特定のステップでのみリトライを増やしたり、プロキシを切り替えたりするのが困難です。
- **提案**:
    - 各 API ステップをミドルウェア（プラグイン）として構築し、処理のパイプライン化を行う。
- **メリット**: レート制限対策や監視ログの挿入などが、既存コードを汚さずに柔軟に実現できます。

## 3. 既存課題の技術的解決策 (Technical Debts)

### 3.1 接続・セッション管理の抜本的改善
- **現状**: `_fetchWithEachSession` によりリクエストごとに session をオープンしており、コネクションプールの恩恵を受けられていません。
- **提案**: `ApiAsyncProcBase` のライフサイクルに合わせた単一の `aiohttp.ClientSession` インスタンスを、コンストラクタ経由で受け渡す依存性注入 (DI) パターンを採用してください。

---

## 期待される効果 (Expected Impact)

| 提案内容 | 保守性 | 可読性 | 拡張性 | 備考 |
| :--- | :---: | :---: | :---: | :--- |
| **設計のパターン化** | ◎ | ◎ | ◎ | 重複コードの80%削減が見込める |
| **抽出の部品化** | ○ | ◎ | ○ | ロジックの再利用性が向上 |
| **スキーマ導入** | ◎ | ○ | ○ | 型安全によるバグの早期発見 |
| **設定の外部化** | ◎ | ○ | ◎ | サイト変更への即応性が向上 |
