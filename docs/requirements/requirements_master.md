# 要件定義書 (Requirements Specification)

## 1. プロジェクト概要

### 1.1 目的

本システムは、日本の主要不動産会社5社のWebサイトから不動産物件情報を自動収集し、構造化されたデータベースに保存することを目的とする。

### 1.2 背景

不動産投資や物件購入の意思決定には、複数の不動産会社の物件情報を横断的に比較・分析する必要がある。しかし、各社のWebサイトは独自のフォーマットで情報を提供しており、手動での情報収集・整理には多大な時間とコストがかかる。本システムは、この課題を自動化により解決する。

### 1.3 スコープ

**対象範囲:**
- 5社の不動産会社サイトからの物件情報収集
- 4種類の物件タイプ（投資用、マンション、戸建て、土地）
- データの正規化とデータベース保存
- ローカル環境での実行

**対象外:**
- リアルタイム監視・通知機能
- ユーザー向けフロントエンドUI
- データ分析・可視化機能
- クラウド環境への自動デプロイ

---

## 2. 機能要件

### 2.1 データ収集機能

#### FR-001: 対象サイト
システムは以下の5社のWebサイトから物件情報を収集できること。

| 会社名 | 対象サイト |
|--------|-----------|
| 三井のリハウス | https://www.rehouse.co.jp/ |
| 住友不動産販売 | https://www.stepon.co.jp/ |
| 東急リバブル | https://www.livable.co.jp/ |
| 野村の仲介+ | https://www.nomu.com/ |
| ミサワホーム不動産 | https://realestate.misawa.co.jp/ |

#### FR-002: 物件種別
システムは以下の4種類の物件タイプを収集できること。

1. **投資用不動産** (investment)
   - 一棟マンション（RC造・鉄骨造などの集合住宅一棟）
   - 一棟アパート（木造・軽量鉄骨造などの集合住宅一棟）
   - 投資用戸建て（賃貸収入目的の一戸建て）

   > [!NOTE]
   > 区分マンション、ビル、店舗/事務所、工場/倉庫、ホテル/旅館などは収集対象外

   **サイト別取得対象一覧:**

   | 会社名 | 一棟マンション | 一棟アパート | 投資用戸建て | 備考 |
   |--------|-------------|------------|------------|------|
   | 三井のリハウス | ○ | ○ | ○ | |
   | 住友不動産販売 | ○ | ○ | ○ | |
   | 東急リバブル | ○ | ○ | × | 戸建てカテゴリなし |
   | 野村の仲介+ | ○ | ○ | ○ | |
   | ミサワホーム不動産 | ○ | ○ | × | 戸建てカテゴリなし |

2. **中古マンション** (mansion)
   - 区分所有マンション

3. **戸建て** (kodate)
   - 中古戸建て
   - 新築戸建て

4. **土地** (tochi)
   - 宅地
   - 更地

#### FR-003: 収集データ項目
※詳細な収集項目は、本ドキュメント末尾の「投資用物件 サンプルURL・取得項目調査」セクションを参照してください。

---

# 投資用物件 サンプルURL・取得項目調査

各不動産サイトにおける「投資用・事業用」物件のURL構造とサンプルURL、および取得すべきデータ項目の調査結果です。

## 1. 三井のリハウス (Mitsui Rehouse)

**遷移フロー:**
`トップ` -> `投資・事業用トップ` -> `都道府県選択` -> `物件種別選択 (一棟マンション等)` -> `一覧` -> `詳細`

| ページ種別 | URLパターン / サンプル | 備考 |
| :--- | :--- | :--- |
| **トップ** | https://www.rehouse.co.jp/buy/tohshi/ | 投資用トップ |
| **一覧 (一棟マンション)** | https://www.rehouse.co.jp/buy/tohshi/shueki/mansion/prefecture/13/ | 東京都 |
| **一覧 (一棟アパート)** | https://www.rehouse.co.jp/buy/tohshi/shueki/apartment/prefecture/13/ | 東京都 |
| **詳細 (一棟マンション)** | https://www.rehouse.co.jp/buy/tobkdetail/F21X2A03/ | 事業用ページ |
| **詳細 (一棟アパート)** | https://www.rehouse.co.jp/buy/tobkdetail/F00X2A01/ | 事業用ページ |

## 2. 住友不動産ステップ (Sumitomo Step)

**遷移フロー:**
`トップ` -> `投資用トップ` -> `エリア検索` -> `一覧` -> `詳細`

| ページ種別 | URLパターン / サンプル | 備考 |
| :--- | :--- | :--- |
| **トップ** | https://www.stepon.co.jp/pro/ | 投資用トップ |
| **一覧 (東京全域)** | https://www.stepon.co.jp/search/list/?type=pro2&searchType=area&prefCd=13 | パラメータで絞り込み |
| **詳細 (一棟マンション)** | https://www.stepon.co.jp/pro/detail_15223132/ | ID形式 |
| **詳細 (一棟アパート)** | https://www.stepon.co.jp/pro/detail_14233005/ | |
| **詳細 (投資用戸建)** | https://www.stepon.co.jp/pro/detail_13214008/ | |

## 3. 東急リバブル (Tokyu Livable)

**遷移フロー:**
`トップ` -> `投資用トップ` -> `エリア選択` -> `一覧` -> `詳細`

| ページ種別 | URLパターン / サンプル | 備考 |
| :--- | :--- | :--- |
| **トップ** | https://www.livable.co.jp/fudosan-toushi/ | 投資用トップ |
| **一覧 (東京全域)** | https://www.livable.co.jp/fudosan-toushi/tatemono-tokyo-select-area/a13000/ | |
| **詳細 (一棟マンション)** | https://www.livable.co.jp/fudosan-toushi/C1325YE45/ | ID形式 |
| **詳細 (一棟アパート)** | https://www.livable.co.jp/fudosan-toushi/C4825Z921/ | |
| **詳細 (投資用戸建)** | *収集対象外* | |

## 4. ノムコム・プロ (Nomucom Pro)

**遷移フロー:**
`トップ` -> `検索条件入力` -> `一覧` -> `詳細`

| ページ種別 | URLパターン / サンプル | 備考 |
| :--- | :--- | :--- |
| **トップ** | https://www.nomu.com/pro/ | |
| **一覧 (検索結果)** | https://www.nomu.com/pro/search/?area_ids[]=1311 | GETパラメータ |
| **詳細 (一棟マンション)** | https://www.nomu.com/pro/bukken_local_id/RF870129/ | |
| **詳細 (一棟アパート)** | https://www.nomu.com/pro/bukken_local_id/A7770005/ | |
| **詳細 (投資用戸建)** | https://www.nomu.com/pro/bukken_local_id/FB6BX015/ | |

## 5. ミサワホーム不動産 (Misawa Home)

**遷移フロー:**
`トップ` -> `事業用検索` -> `地域選択` -> `一覧` -> `詳細`

| ページ種別 | URLパターン / サンプル | 備考 |
| :--- | :--- | :--- |
| **トップ** | https://realestate.misawa.co.jp/search/sale/ | |
| **一覧 (東京・投資)** | https://realestate.misawa.co.jp/search/sale/list/?pref=tokyo&bukken_type[]=9 | bukken_type=9が投資用 |
| **詳細 (一棟マンション)** | https://realestate.misawa.co.jp/search/sale/detail/9533107/ | |
| **詳細 (一棟アパート)** | https://realestate.misawa.co.jp/search/sale/detail/9531093/ | |



**全物件共通項目:**
- 物件名 / タイトル
- 価格（文字列・数値）
- 住所
- 交通情報（最大5路線）
- 登録日時
- 物件詳細ページURL

**マンション固有項目:**
- 専有面積
- 間取り
- 所在階
- 築年月
- 管理費
- 修繕積立金
- バルコニー面積

**戸建て固有項目:**
- 土地面積
- 建物面積
- 構造
- 築年月
- 建ぺい率
- 容積率

**土地固有項目:**
- 土地面積
- 地目
- 建ぺい率
- 容積率
- 用途地域
- 接道状況

**投資用固有項目:**
- 表面利回り
- 年間想定賃料
- 土地面積
- 建物面積
- 構造
- 総戸数（アパート・マンションの場合）

#### FR-004: データ収集フロー
システムは以下のステップで物件情報を収集すること。

1. **Start**: クローリング開始、地域選択
2. **Region/Area**: 都道府県・市区町村の選択
3. **List**: 物件一覧ページの走査
4. **Detail**: 物件詳細ページの解析・保存

### 2.2 データ保存機能

#### FR-005: データベース保存
- 収集した物件情報をMySQLデータベースに保存すること
- 各社・各物件種別ごとに専用のテーブルを持つこと（合計17テーブル）
- 重複物件は`pageUrl`で識別し、更新すること

#### FR-006: データ正規化
以下のデータ正規化を実施すること。

**Dual Storage Pattern:**
- 価格: `priceStr` (例: "5,480万円") + `price` (例: 54800000)
- 面積: `senyuMensekiStr` (例: "81.65㎡") + `senyuMenseki` (例: 81.65)

**Transportation Fields Pattern:**
- 最大5路線の交通情報を保持
- 各路線につき8フィールド（路線名、駅名、徒歩分数等）

**Computed Fields:**
- 旧耐震判定（1982年1月1日以前）
- 平米単価（管理費・修繕積立金）
- 階数情報の分解（所在階、地上階数、地下階数）

#### FR-007: データバリデーション
以下のフィールドは必須とし、欠損時はレコードを保存しないこと。

**全モデル共通:**
- `propertyName`, `pageUrl`, `inputDate`, `price`, `address`
- `railway1` (または `traffic`)

**物件種別ごと:**
- **Mansion**: `senyuMenseki`, `madori`
- **Kodate**: `tochiMenseki`, `tatemonoMenseki`
- **Tochi**: `tochiMenseki`, `kenpei`, `youseki`
- **Investment**: `landArea`, `buildingArea`

### 2.3 実行制御機能

#### FR-008: コマンドライン実行
Taskコマンドにより以下の操作が可能であること。

```bash
# 初期セットアップ
task init

# サーバー起動
task default

# クローラー実行
task crawl COMPANY={company} TYPE={type}

# ログ確認
task logs

# テスト実行
task test

# サーバー停止
task stop
```

#### FR-009: 並列処理制御
- Region/List API: 並列数2
- Detail API: 並列数6
- TCP接続プール: 上限100

---

## 3. 非機能要件

### 3.1 性能要件

#### NFR-001: レスポンス時間
- 各APIエンドポイントは即座にHTTP 200を返却すること（Fire-and-Forget方式）
- タイムアウト設定: 3.0秒

#### NFR-002: スループット
- 詳細ページ取得: 同時6物件まで並列処理
- 一覧ページ取得: 同時2ページまで並列処理

### 3.2 可用性要件

#### NFR-003: エラーハンドリング
- ネットワークエラー時: 10秒待機後に1回リトライ
- DB接続エラー時: 30秒待機後に再試行
- タイムアウト: 成功とみなして処理継続

#### NFR-004: ログ出力
- 全てのエラーをログに記録すること
- バリデーションエラー時は物件名・URL・欠損フィールドを出力すること

### 3.3 保守性要件

#### NFR-005: コード構造
- 各社ごとに独立したパーサークラスを持つこと
- 共通処理は基底クラス（`ApiAsyncProcBase`）に集約すること
- サイト構造変更時は該当パーサーのみ修正すること

#### NFR-006: テスト
- 各パーサーに対してユニットテストを実装すること
- pytestによる自動テストが実行可能であること

### 3.4 拡張性要件

#### NFR-007: 新規サイト追加
- 新規不動産会社の追加が容易であること
- パーサークラスとモデルクラスの追加のみで対応可能であること

#### NFR-008: サーバーレス対応
- Google Cloud Functions等のサーバーレス環境で実行可能な設計であること
- Fire-and-Forget方式により、各ステップが独立して実行可能であること

### 3.5 セキュリティ要件

#### NFR-009: アクセス制御
- 対象サイトへの過度なアクセスを避けるため、並列数を制限すること
- User-Agentヘッダーを適切に設定すること

---

## 4. 技術要件

### 4.1 開発環境

#### TR-001: プログラミング言語
- Python 3.10

#### TR-002: 主要ライブラリ
- **HTTP通信**: aiohttp（非同期HTTPクライアント）
- **HTML解析**: BeautifulSoup4 + lxml
- **データベース**: Django ORM + mysqlclient
- **テスト**: pytest

#### TR-003: インフラ
- **コンテナ**: Docker / Docker Compose
- **データベース**: MySQL 8.0
- **タスクランナー**: Task (Taskfile)

### 4.2 実行環境

#### TR-004: システム要件
- Docker Desktop がインストールされていること
- Task コマンドがインストールされていること
- 8000番ポート（アプリケーション）が利用可能であること
- 3306番ポート（MySQL）が利用可能であること

#### TR-005: リソース要件
- メモリ: 最低2GB推奨
- ディスク: 最低5GB推奨（データベース容量含む）

---

## 5. 制約事項

### 5.1 技術的制約

#### C-001: JavaScript非対応
- JavaScriptレンダリングが必要なサイトには対応しない
- 静的HTMLのみを対象とする

#### C-002: 認証非対応
- ログインが必要なサイトには対応しない
- 公開されている物件情報のみを対象とする

### 5.2 運用上の制約

#### C-003: 実行頻度
- 対象サイトへの負荷を考慮し、過度な頻度での実行は避けること
- 推奨実行頻度: 1日1回程度

#### C-004: データ保持
- 収集したデータの著作権は各不動産会社に帰属する
- データの二次利用・再配布は行わないこと

---

## 6. 前提条件

### 6.1 対象サイトの前提

#### P-001: HTML構造の安定性
- 対象サイトのHTML構造が頻繁に変更されないこと
- 変更時はパーサーの修正が必要

#### P-002: アクセス制限
- 対象サイトがクローリングを明示的に禁止していないこと
- robots.txtに準拠すること

### 6.2 実行環境の前提

#### P-003: ネットワーク接続
- インターネットへの安定した接続が確保されていること
- ファイアウォール等でHTTP/HTTPS通信が制限されていないこと

---

## 7. 用語定義

| 用語 | 定義 |
|------|------|
| Fire-and-Forget | 処理完了を待たずに即座にレスポンスを返す非同期処理方式 |
| Dual Storage Pattern | 同一データを文字列と数値の両方で保持するデータ設計パターン |
| Transportation Fields | 最大5路線の交通情報を保持するフィールド群 |
| Computed Fields | パース時に計算される派生フィールド（旧耐震判定、平米単価等） |
| 厳格化フィールド | `null=False`で定義され、欠損時にレコード保存をスキップするフィールド |

---


## 8. 参照ドキュメント

- [投資用不動産 種別調査](investment_property_types.md): 各サイトの投資用物件種別に関する詳細調査
- [Sumifuクローリング報告書](sumifu_crawling_report.md): 住友不動産販売のクローリング状況レポート
- [クローラー仕様書](../basic_design/basic_design_master.md): アーキテクチャ、処理フロー詳細
- [データベース定義書](../detailed_design/detailed_design_master.md): テーブル・カラム定義
- [API構造](../detailed_design/detailed_design_master.md): エンドポイント構造、Fire-and-Forget実装
- [開発者ガイド](../implementation/developer_guide_master.md): 環境構築、デバッグ方法
- [サイト構造ドキュメント](site_structures/): 各社のサイト構造詳細

---

**作成日**: 2026年1月17日  
**バージョン**: 1.0 (ラフ版)  
**ステータス**: Draft


