# クローラー仕様書 (Crawler Specification)

本プロジェクトのクローラーにおけるアーキテクチャ、処理フロー、および技術的な詳細仕様について記載します。

## 1. アーキテクチャ概要 (Architecture)

### 対応種別
本クローラーは、以下の不動産種別に対応しています。
*   **マンション**
*   **土地**
*   **戸建**

### Fire-and-Forget 方式
本クローラーは、Google Cloud Functions などのサーバーレス環境での実行も想定し、「Fire-and-Forget」方式の非同期API呼び出しを採用しています。

*   **再帰的呼び出し**: `Start` -> `Area` -> `List` -> `Detail` の各ステップは、次のステップのAPIエンドポイントをHTTPリクエストで呼び出すことで連鎖します。
*   **即時レスポンス**: 呼び出し元の関数は、リクエストを送信した後、処理の完了を待たずに即座にレスポンス（ステータス 200）を返します。
*   **タイムアウト設定**: 次の処理をトリガーする際のリクエストタイムアウトは **3.0秒** に設定されており、接続が確立された時点で成功とみなします（実際の処理完了を待ちません）。

### 構成
本システムは `python:3.10-slim` イメージを使用し、不要なブラウザエンジン（Playwright）を排除した最小構成です。
すべてのサイトが `aiohttp` による HTTP リクエストと `BeautifulSoup4` による HTML 解析で完結するよう設計されています。

*   **TCPコネクタ制限**: `TCP_CONNECTOR_LIMIT = 100` (全体)
*   **詳細ページ取得時の並列数**:
    *   デフォルト: `DEFAULT_PARARELL_LIMIT = 2`
    *   詳細ページ (`DetailFunc`): `DETAIL_PARARELL_LIMIT = 6`

## 2. エラーハンドリング & リトライ (Error Handling)

クローリングの安定性を高めるため、以下のエラーハンドリングを実装しています。

*   **接続エラー (`ClientConnectorError`, `ServerDisconnectedError`)**:
    *   一時的なネットワーク障害とみなし、**1回のリトライ**を実施します。
    *   リトライ前に待機時間（`sleep(10)` = 10秒）を設けています。
*   **タイムアウト (`TimeoutError`)**:
    *   Fire-and-Forget の設計上、タイムアウトは**「リクエスト送信成功」**として扱います。エラーログは出力せず、処理を継続します。
*   **DB接続エラー (`OperationalError`)**:
    *   DBへの同時接続過多などで保存に失敗した場合、**30秒待機**してから再試行します。

## 3. データ保存 (Data Persistence)

*   **保存タイミング**:
    *   物件詳細ページ (`DetailFunc`) の解析が完了した直後に、1件ごとにデータベースへ保存 (`save()` メソッド) します。
    *   バッチ処理でまとめて保存する方式ではありません。
*   **重複管理**:
    *   同一物件が既に存在する場合の挙動はモデル定義および `save` メソッドの実装に依存しますが、基本的には `inputDate` 等を含めて履歴として保持するか、最新状態で更新します。

## 4. 処理フロー詳細 (Process Flow)

各サイトのクローリングは、以下のエンドポイント連鎖によって実行されます。

### 三井のリハウス (`mitsui`)
#### マンション
1.  **Start** (`/api/mitsui/mansion/start`): トップページから都道府県一覧を取得し、Area APIを呼び出し。
2.  **Area** (`/api/mitsui/mansion/area`): 都道府県ページから市区町村一覧を取得し、List APIを呼び出し。
3.  **List** (`/api/mitsui/mansion/list`): 市区町村の物件一覧ページをページングしながら全件走査し、Detail APIを呼び出し。
4.  **Detail** (`/api/mitsui/mansion/detail`): 物件詳細ページを解析し、DB保存。

#### 土地 (`tochi`)
1.  **Start** (`/api/mitsui/tochi/start`): 土地トップページから都道府県一覧を取得。
2.  **Area** (`/api/mitsui/tochi/area`): エリアページから市区町村一覧を取得。
3.  **List** (`/api/mitsui/tochi/list`): 物件一覧ページを走査。
4.  **Detail** (`/api/mitsui/tochi/detail`): 土地詳細情報を解析。

#### 戸建 (`kodate`)
1.  **Start** (`/api/mitsui/kodate/start`): 戸建トップページから都道府県一覧を取得。
2.  **Area** (`/api/mitsui/kodate/area`): エリアページから市区町村一覧を取得。
3.  **List** (`/api/mitsui/kodate/list`): 物件一覧ページを走査。
4.  **Detail** (`/api/mitsui/kodate/detail`): 戸建詳細情報を解析。

### 住友不動産販売 (`sumifu`)
1.  **Start** (`/api/sumifu/mansion/start`): 地域選択ページへアクセス。
2.  **Region** (`/api/sumifu/mansion/region`): 地域ページから市区町村リストを特定。
3.  **List** (`/api/sumifu/mansion/list`): 物件一覧を取得。`mode=2` (リスト形式) を使用。
4.  **Detail** (`/api/sumifu/mansion/detail`): 物件詳細ページ解析 & 保存。

### 東急リバブル (`tokyu`)
1.  **Start** (`/api/tokyu/mansion/start`): エリア選択ページへアクセス。
2.  **Area** (`/api/tokyu/mansion/area`): 市区町村を選択。
3.  **List** (`/api/tokyu/mansion/list`): 検索結果一覧をページング。
4.  **Detail** (`/api/tokyu/mansion/detail`): 物件詳細ページ解析 & 保存。

### ミサワホーム不動産 (`misawa`)
1.  **Start** (`/api/misawa/mansion/start`): 検索トップから地域選択へ。
2.  **List** (`/api/misawa/mansion/list`): 一覧ページを解析。物件名が `h2` または `h1` に存在する新構造に対応。
3.  **Detail** (`/api/misawa/mansion/detail`): 物件詳細の解析 & 保存。

## 5. 詳細ページの解析ロジック (Parsing Logic)

HTML解析には `BeautifulSoup4` を使用しています。

### 基本戦略
1.  **要素の特定**: `select_one` (CSSセレクタ) や `find_all` を使用して対象データを特定します。
2.  **テーブル走査**: 物件詳細情報の多くは `<table>` タグ内にあります。`tr` 行をループし、`th` (項目名) に応じて `td` (値) を取得します。
3.  **データ整形**:
    *   価格: 「万円」「円」等の文字を除去し、`int` 型に変換（「億」単位の計算含む）。
    *   面積: 「㎡」等の単位を除去し、数値のみを抽出。

### サイト固有のパーシング詳細・特記事項

#### 三井のリハウス (全般共通)
*   **物件名**: `h1.headline1` から取得（失敗時は `h1.headline1 mb-4` へフォールバック）。
*   **接道状況**: 文字列パースにより道路幅員（メートル）を取得。`接道状況` 項目文字列内に複数の道路情報が含まれる場合、**最も幅員が広い道路** を採用してデータを保存します。
*   **建ぺい率・容積率**: 「前面道路幅員により...」という記載がある場合、制限後の数値を優先して抽出するロジックが含まれています。

#### 三井のリハウス (マンジョンスペシフィック)
*   **階数情報**: `階数 / 階建` の情報から以下のように分解して保存します。
    *   `floorType_kai`: 所在階
    *   `floorType_chijo`: 地上階数
    *   `floorType_chika`: 地下階数
*   **旧耐震判定**: 築年月が **1982年1月1日以前** の場合、旧耐震 (`kyutaishin = 1`) と判定するロジックがあります。
*   **平米単価計算**: 管理費・修繕積立金について、専有面積で割った平米単価 (`_p_heibei`) を自動計算しています。
*   **構造**: 鉄筋コンクリート造等は「RC造」「SRC造」などの略称に変換して保存されます。

#### 三井のリハウス (戸建・土地スペシフィック)
*   **戸建構造**: 「木造2階建」のような文字列から、構造（木造）と階数（2）を分離して保存します。
*   **土地項目**: 「建築条件」「地目」「都市計画」「国土法届出要否」などの法規制項目も取得対象です。

#### 住友不動産販売 (Investment)
*   **物件種別**: 「マンション（一棟）」「アパート（一棟）」「ビル（一棟）」等の種別を詳細に取得し、`propertyType` に保存。
*   **利回り・賃料**: `grossYield` (表面利回り) のほか、`annualRent` (想定年収), `monthlyRent` (月額) を個別にパース。

#### 東急リバブル (Investment)
*   **道路情報**: 投資用物件においても詳細な接道状況 (`startRoad`) を取得。

#### 野村の仲介＋ (Investment)
*   **面積**: `landArea` (土地面積) と `buildingArea` (建物面積) がテキスト形式で保持されており、一棟ものと区分マンションの両方に対応。

#### ミサワホーム不動産
*   **物件名**: `h1.detail-title` が基本だが、構造変更により `h2` または generic な `h1` も対象とするフォールバック・ロジックを実装。

#### 東急リバブル
*   **定義リスト**: `div.m-status-table__wrapper` 内の `dl` (Definition List) を使用している箇所がある点が特徴。
